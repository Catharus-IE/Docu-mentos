name: Observatory Update

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Metadata
        run: |
          #!/bin/bash
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SAN=$(( $(shuf -i 30-99 -n 1) ))  # ä½¿ç”¨ shuf ç”Ÿæˆéšæœºæ•°

          echo "å½“å‰æ—¶é—´ï¼š${DATE}"
          echo "SAN å€¼ï¼š${SAN}"

          # æ£€æŸ¥ README.md æ–‡ä»¶å†…å®¹æ˜¯å¦ç¬¦åˆé¢„æœŸ
          if ! grep -q "æœ€åæ ¡å‡†æ—¶é—´ï¼š" README.md; then
            echo "æœªæ‰¾åˆ° 'æœ€åæ ¡å‡†æ—¶é—´'ï¼Œè¯·æ£€æŸ¥ README.md æ–‡ä»¶æ ¼å¼"
            exit 1
          fi

          if ! grep -q "SAN-" README.md; then
            echo "æœªæ‰¾åˆ° 'SAN-'ï¼Œè¯·æ£€æŸ¥ README.md æ–‡ä»¶æ ¼å¼"
            exit 1
          fi

          # æ›¿æ¢ README å†…å®¹
          chmod +w README.md
          sed -i.bak "s/æœ€åæ ¡å‡†æ—¶é—´ï¼š.*/æœ€åæ ¡å‡†æ—¶é—´ï¼š${DATE}/" README.md
          sed -i.bak "s/SAN-.*/SAN-${SAN}\/99-critical/" README.md

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸŒŒ è‡ªåŠ¨æ›´æ–°è§‚æµ‹æ•°æ®"
          branch: main
